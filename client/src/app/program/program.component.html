<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-back-button text="" icon="chevron-back-outline"></ion-back-button>
        </ion-buttons>
        <ion-title>
            {{'custom_program' | translate}}
        </ion-title>
    </ion-toolbar>

    <ion-row class="ion-padding-x">
        <ion-segment scrollable [(ngModel)]="activeTab" [ngModelOptions]="{standalone: true}" (ionChange)="tabChange()">
            <ion-segment-button value="info">
                <ion-label>{{ 'info' | translate }}</ion-label>
            </ion-segment-button>

            @for (week of getWeeksArray().controls; track $index; let i = $index) {
            <ion-segment-button [value]="'week-'+i">
                <ion-label> {{ 'week' | translate }} {{i+1}}</ion-label>
            </ion-segment-button>
            }
        </ion-segment>
    </ion-row>
</ion-header>

<ion-content class="bg_color" fullscreen>
    <form [formGroup]="programForm" (ngSubmit)="saveChanges()">
        @if (activeTab === 'info') {
        <div class="form">
            <ion-item>
                <ion-input label="{{ 'name' | translate }}" labelPlacement="floating" formControlName="name"
                    type="text"></ion-input>
            </ion-item>
            <ion-item>
                <ion-textarea label="{{ 'description' | translate }}" labelPlacement="floating"
                    formControlName="description" rows="3"></ion-textarea>
            </ion-item>
            <ion-item>
                <ion-label>{{ 'duration_weeks' | translate }}</ion-label>
                <ion-select formControlName="duration">
                    @for (num of weeks; track num) {
                    <ion-select-option [value]="num">
                        {{num}} {{ 'weeks' | translate }}
                    </ion-select-option>
                    }
                </ion-select>
            </ion-item>

            <ion-item lines="none">
                <ion-label>
                    <ion-list>
                        @for (user of getAssignedUsers().controls; track user.get('id').value) {
                        <ion-item-sliding>
                            <ion-item>
                                <ion-avatar slot="start">
                                    <img [src]="user.get('avatar').value">
                                </ion-avatar>
                                <ion-label>
                                    <h2>{{ user.get('name').value }}</h2>
                                    <p>{{ user.get('email').value }}</p>
                                </ion-label>
                            </ion-item>
                            <ion-item-options side="end">
                                <ion-item-option color="danger" (click)="removeAssignedUser(user.get('id').value)">
                                    <ion-icon slot="icon-only" name="trash"></ion-icon>
                                </ion-item-option>
                            </ion-item-options>
                        </ion-item-sliding>
                        } @empty{
                        <ion-item lines="none">
                            <ion-label class="ion-text-center" [color]="'medium'">
                                {{ 'no_users_assigned' | translate }}
                            </ion-label>
                        </ion-item>
                        }
                    </ion-list>
                    <div class="ion-padding-bottom">
                        <ion-button size="medium" expand="block" fill="clear" (click)="openAssignUsersModal()">
                            {{ 'add_user' | translate }}
                        </ion-button>
                    </div>
                </ion-label>
            </ion-item>
        </div>
        }

        <ng-container formArrayName="weeks">
            @for (week of getWeeksArray().controls; track $index; let weekIndex = $index) {
            @if(activeTab == 'week-'+weekIndex) {
            <div class="exercise-list" [formGroupName]="weekIndex">
                <div class="week-layout">
                    <div class="days-sidebar">
                        <div class="day-pills-container">
                            <div class="day-pills">
                                @for (day of getDaysArray(weekIndex).controls; track $index; let dayIndex = $index) {
                                <div class="day-pill" [class.active-day]="activeDayIndex === dayIndex"
                                    (click)="setActiveDay(dayIndex)">
                                    {{dayIndex + 1}}
                                </div>
                                }
                                <div class="day-pill add-pill" (click)="addDay(weekIndex)">
                                    <ion-icon name="add-outline"></ion-icon>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="day-content" formArrayName="days">
                        @if (getDaysArray(weekIndex).length > 0 && activeDayIndex !== null) {
                        <div [formGroupName]="activeDayIndex">
                            <div class="day-header">
                                <h3 class="ion-color-light">{{ 'day' | translate }} {{activeDayIndex+1}}</h3>
                                <div class="day-actions">
                                    <ion-button fill="clear" size="small" [color]="'medium'"
                                        (click)="presentDayActionPopover($event, weekIndex, activeDayIndex)">
                                        <ion-icon name="ellipsis-vertical"></ion-icon>
                                    </ion-button>
                                </div>
                            </div>

                            <div formArrayName="exercises">
                                @for (exercise of getExercisesArray(weekIndex, activeDayIndex).controls; track
                                $index; let
                                exIndex = $index) {
                                <ion-item-sliding [formGroupName]="exIndex">
                                    <ion-item lines="none" class="ion-no-border ion-no-padding">
                                        <app-exercise-form [style.width]="'100%'" [exercise]="exercise">
                                        </app-exercise-form>
                                    </ion-item>

                                    <ion-item-options side="end">
                                        <ion-item-option color="danger"
                                            (click)="removeExercise(weekIndex, activeDayIndex, exIndex)">
                                            <ion-icon slot="icon-only" name="trash"></ion-icon>
                                        </ion-item-option>
                                    </ion-item-options>
                                </ion-item-sliding>
                                }
                                @empty {
                                <ion-label [color]="'medium'">
                                    {{ 'no_exercise_added' | translate }}
                                </ion-label>
                                }

                                <ion-button fill="clear" expand="block"
                                    (click)="addExerciseToDay(weekIndex, activeDayIndex)">
                                    {{ 'add_exercise' | translate }}
                                </ion-button>
                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>
            }
            }
        </ng-container>
    </form>
</ion-content>

@if(activeTab === 'info') {
<ion-footer>
    <ion-toolbar>
        <div class="button-group ion-padding">
            <ion-button color="primary" expand="round" class="btn" (click)="saveChanges()">
                {{ 'save' | translate }}
            </ion-button>
        </div>
    </ion-toolbar>
</ion-footer>
}