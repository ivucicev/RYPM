<ion-header>
    <ion-toolbar>
        <ion-title>{{'Activity' | translate}}</ion-title>
    </ion-toolbar>
</ion-header>

<ion-content class="bg_color ion-padding-x" fullscreen>
    <ion-row class="segment-toolbar ion-padding">
        <ion-segment lines="none" [(ngModel)]="tab" (ngModelChange)="onTabChange($event)">
            <ion-segment-button value="workouts">
                <ion-label>
                    {{'Workouts' | translate}}
                </ion-label>
            </ion-segment-button>
            <ion-segment-button value="stats">
                <ion-label>
                    {{'Stats' | translate}}
                </ion-label>
            </ion-segment-button>
            <ion-segment-button value="measurements">
                <ion-label>
                    {{'Body' | translate}}
                </ion-label>
            </ion-segment-button>
        </ion-segment>
    </ion-row>

    <ng-container [ngSwitch]="tab">
        <ng-container *ngSwitchCase="'workouts'">
            <ion-list lines="none">
                @for(workout of workouts; track $index) {
                <ion-card>
                    <div class="inner-card">
                        <ion-card-header>
                            <div class="card-header-container">
                                <div class="user-info">
                                    <ion-icon name="person-circle" size="small"></ion-icon>
                                    <span class="creator-name">
                                        {{ workout?.user.name }}
                                    </span>
                                </div>
                                <div class="datetime">
                                    {{ workout.start | dateTime }}
                                </div>
                                <div class="action-area">
                                    <ion-button color="dark" fill="clear" size="small" (click)="openSettings(workout)">
                                        <ion-icon name="ellipsis-vertical"></ion-icon>
                                    </ion-button>
                                </div>
                            </div>
                        </ion-card-header>
                        <ion-card-content>
                            <ion-note color="medium">
                                @if (workout.load) {
                                <span>
                                    {{ 'Training load' | translate }}: {{ workout.load || 0 }} kg
                                </span>
                                }
                                @if (workout.effort) {
                                <span>
                                    {{ 'Effort' | translate }}: {{ workout.effort }}/10
                                </span>
                                }
                            </ion-note>
                            <div class="exercises-list">
                                @for(exercise of workout.exercises; track $index) {
                                <span class="exercise-item">
                                    {{ exercise.name }} ({{ exercise.sets?.length }} {{'sets' | translate}})@if ($index
                                    < workout.exercises.length - 1){,&nbsp;} </span>
                                        }
                            </div>
                            @if (workout.tagsToShow?.length > 0) {
                            <div class="tag-container">
                                @for (tag of workout.tagsToShow; track $index) {
                                <ion-chip color="primary" size="small">{{ tag }}</ion-chip>
                                }
                            </div>
                            }
                        </ion-card-content>
                    </div>
                </ion-card>
                } @empty {
                <app-no-data [text]="'No activities yet.' | translate"></app-no-data>
                }
            </ion-list>
        </ng-container>
        <ng-container *ngSwitchCase="'stats'">
            <div class="ion-padding-x">
            </div>
            <div class="ion-padding-x">
                <h6 class="ion-display-flex flex">
                    <div class="ion-flex-1 flex50 ion-padding-y">
                        {{ 'Effort' | translate }}
                    </div>
                    <ion-select class="ion-flex-1 flex50" style="padding-top: 3px" (ionChange)="onPeriodChange($event)"
                        toggleIcon="filter-outline" [(ngModel)]="selectedPeriod" interface="popover"
                        label="{{ '' | translate }}">
                        @for (item of periods; track $index) {
                        <ion-select-option [value]="item.id">{{ item.name }}</ion-select-option>
                        }
                    </ion-select>
                </h6>
                <canvas #effortChart></canvas>
                <h6>
                    {{ 'Total volume' | translate }}
                </h6>
                <canvas #volumeChart></canvas>
                <h6>
                    <ion-select interface="modal" toggleIcon="filter-outline"
                        (ionChange)="volumePerMuscleGroupChange($event)" [(ngModel)]="volumePerMuscleGroup"
                        label="{{ 'Volume per muscle group' | translate }}">
                        @for (item of allMuscles; track $index) {
                        <ion-select-option [value]="item">{{ item.charAt(0).toUpperCase() + item.slice(1).toLowerCase()
                            | translate }}</ion-select-option>
                        }
                    </ion-select>
                </h6>
                <canvas #maxPerMuscleGroup></canvas>
                <h6>
                    <ion-select interface="modal" toggleIcon="filter-outline"
                        (ionChange)="maxPerWorkoutExerciseChange($event)" [(ngModel)]="maxPerWorkoutExercise"
                        label="{{ 'Max. Load' | translate }}">
                        @for (item of allExercises; track $index) {
                        <ion-select-option [value]="item">{{ item }}</ion-select-option>
                        }
                    </ion-select>
                </h6>
                <canvas #maxPerWorkout></canvas>
                <h6>
                    <ion-select interface="modal" toggleIcon="filter-outline"
                        (ionChange)="maxLoadPerWorkoutExerciseChange($event)" [(ngModel)]="maxLoadPerWorkoutExercise"
                        label="{{ 'Max. Volume' | translate }}">
                        @for (item of allExercises; track $index) {
                        <ion-select-option [value]="item">{{ item }}</ion-select-option>
                        }
                    </ion-select>
                </h6>
                <canvas #maxLoadPerWorkout></canvas>
                <h6>
                    <ion-select interface="modal" toggleIcon="filter-outline"
                        (ionChange)="maxVolumePerWorkoutExerciseChange($event)"
                        [(ngModel)]="maxVolumePerWorkoutExercise" label="{{ 'Total Volume' | translate }}">
                        @for (item of allExercises; track $index) {
                        <ion-select-option [value]="item">{{ item }}</ion-select-option>
                        }
                    </ion-select>
                </h6>
                <canvas #volumePerWorkout></canvas>
            </div>
        </ng-container>
        <ng-container *ngSwitchCase="'measurements'">
            <swiper-container [centeredSlides]="true" [slidesPerView]="1" [loop]="false" [pagination]="true"
                [zoom]="true">
                @for(photo of progressPhotos; track photo) {
                <swiper-slide>
                    <ion-card class="ion-text-center">
                        <ion-card-header>
                            <div class="card-header-container">
                                <div class="action-area">
                                    <ion-button (click)="openPhotoSettings(photo)" color="dark" fill="clear"
                                        size="small">
                                        <ion-icon name="ellipsis-vertical"></ion-icon>
                                    </ion-button>
                                </div>
                            </div>
                        </ion-card-header>
                        <img height="250px" [src]="photo.photo" />
                        <ion-card-header>
                            <ion-card-subtitle style="padding-bottom: 15px;">{{ photo.date | dateTime
                                }}</ion-card-subtitle>
                        </ion-card-header>
                    </ion-card>
                </swiper-slide>
                }
            </swiper-container>
            <ion-list lines="none">
                @for(measurement of measurements; track measurement.name) {
                <ion-item (click)="createOrEditMeasurement(measurement)">
                    <canvas #measurementsGraph></canvas>
                </ion-item>
                } @empty {
                <app-no-data [text]="'No measurements yet.' | translate"></app-no-data>
                }
            </ion-list>
        </ng-container>
    </ng-container>

</ion-content>

@if (tab == 'measurements') {
<ion-fab slot="fixed" horizontal="end" vertical="bottom" style="bottom: 0">
    <ion-fab-button>
        <ion-icon name="add" (click)="presentPopover($event)"></ion-icon>
    </ion-fab-button>
</ion-fab>
}

<ion-popover #popover [isOpen]="actionsPopover" (didDismiss)="actionsPopover = false">
    <ng-template>
        <ion-list>
            <ion-item button (click)="progressPhoto()">
                <ion-label>{{ 'Photo' | translate }}</ion-label>
                <ion-icon [src]="cameraIcon" color="primary"></ion-icon>
            </ion-item>
            @for (measure of measurements; track measure.id) {
            <ion-item button (click)="addEntry(measure)">
                <ion-label>{{ measure.name }}</ion-label>
            </ion-item>
            }
            <ion-item button (click)="createOrEditMeasurement()">
                <ion-label>{{ 'Create' | translate }}</ion-label>
                <ion-icon name="add-outline" color="primary"></ion-icon>
            </ion-item>
        </ion-list>
    </ng-template>
</ion-popover>

<ion-modal [isOpen]="showDetailsModal">
    <ng-template>
        <ion-header>
            <ion-toolbar>
                <ion-title>{{ 'Workout details' | translate }}</ion-title>
                <ion-buttons slot="end">
                    <ion-button (click)="showDetailsModal=false;" [strong]="true">OK</ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
            <div id="details">
                @if (isDark) {
                <img src="/assets/logo-light.png" />
                } @else {
                <img src="/assets/logo-dark.png" />
                }
                <div class="exercises-list">
                    <ion-list>
                        <ion-item>
                            <ion-label>{{ 'Date' | translate }}</ion-label>
                            <ion-note slot="end"> {{ currentWorkout.start | dateTime}}</ion-note>
                        </ion-item>
                        <ion-item>
                            <ion-label>{{ 'Duration' | translate }}</ion-label>
                            <ion-note slot="end"> {{ currentWorkout.start | duration:currentWorkout.end }} </ion-note>
                        </ion-item>
                        <ion-item>
                            <ion-label>{{ 'Training load' | translate }}</ion-label>
                            <ion-note slot="end"> {{ currentWorkout.load || 0 }}</ion-note>
                        </ion-item>
                        <ion-item>
                            <ion-label>{{ 'Effort' | translate }}</ion-label>
                            <ion-note slot="end">{{ currentWorkout.effort }}/10</ion-note>
                        </ion-item>
                        @for(exercise of currentWorkout.exercises; track $index) {
                        <ion-item>
                            <ion-label>{{ exercise.name }}
                                @if (exercise.trendPercent != 0) {
                                @if (exercise.isTrendingUp) {
                                <small class="ion-float-right">
                                    {{exercise.trendPercent.toFixed(1)}}%
                                </small>
                                <ion-icon class="ion-float-right mr5" [src]="upIcon" color="success"></ion-icon>
                                } @else {
                                <small class="ion-float-right">
                                    {{exercise.trendPercent.toFixed(1)}}%
                                </small>
                                <ion-icon class="ion-float-right  mr5" [src]="downIcon" color="danger"></ion-icon>
                                }
                                }
                                <p class="ion-text-right">
                                    <ion-note> {{ exercise.summary }}</ion-note>
                                </p>
                            </ion-label>
                        </ion-item>
                        }
                    </ion-list>
                </div>
                @if (currentWorkout.tags?.length > 0) {
                <div>
                    @for (tag of currentWorkout.tags; track $index) {
                    <ion-chip color="primary" size="small">{{ tag }}</ion-chip>
                    }
                </div>
                }
                @if (currentWorkout.comment) {
                <div class="notes"><ion-icon name="information-circle-outline"></ion-icon>
                    {{ currentWorkout.comment }}
                </div>
                }
            </div>
            <ion-footer class="ion-text-center">
                <ion-button (click)="share()" class="ion-margin">
                    {{'Share' | translate }} <ion-icon class="ion-margin-start" [src]="shareIcon"></ion-icon>
                </ion-button>
            </ion-footer>
        </ion-content>
    </ng-template>
</ion-modal>

<app-continue-footer></app-continue-footer>