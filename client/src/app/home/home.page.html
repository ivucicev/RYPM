<ion-header class="modern-header">
    <ion-toolbar>
        <ion-title>{{ 'Workouts' | translate }}</ion-title>
        @if (workouts?.length == 0) {
        <ion-buttons slot="end">
            <button class="header-action-button" (click)="openNewWorkout()">
                <ion-icon name="add-circle" class="plus-icon"></ion-icon>
                <span>{{ 'New workout' | translate }}</span>
            </button>
        </ion-buttons>
        }
    </ion-toolbar>
</ion-header>

<ion-content class="bg_color" fullscreen fixed-slot-placement="before">

    @if (workouts?.length) {
    <div class="ion-padding-x ion-padding">
        <ion-label>{{ 'Active' | translate }}</ion-label>
        <swiper-container slides-per-view="auto" space-between="15" style="width:100%;height:min-content;">
            <!-- [pagination]="true" scrollbar-hide="true" -->
            @for (workout of workouts; track $index) {
            <swiper-slide>
                <ion-card class="workout-card" (click)="openWorkout(workout.id)">
                    <ion-card-header>
                        <ion-label class="header-row" [color]="'medium'">
                            <span>{{ workout.start | dateTime }}</span>
                            <app-time-badge [initialTime]="workout.start"></app-time-badge>
                        </ion-label>
                    </ion-card-header>
                    <ion-card-content>
                        @if (workout.nextExercise) {
                        <div class="exercise-row">
                            <div class="exercise-header">
                                {{ workout.nextExercise.name }}
                                @if (workout.nextExercise.restDuration) {
                                <span class="rest-info">
                                    <ion-icon name="timer-outline"></ion-icon>
                                    <span>{{ 'Rest' | translate }}: {{ workout.nextExercise.restDuration }}s</span>
                                </span>
                                }
                            </div>
                            @if (workout.nextExercise.nextSet) {
                            <div class="next-set-row">
                                <ion-icon name="arrow-forward-circle-outline" [color]="'primary'"></ion-icon>
                                <ion-label>
                                    <ng-container
                                        *ngTemplateOutlet="setValueTemplate; context: { set: workout.nextExercise.nextSet, previous: false }"></ng-container>
                                </ion-label>
                            </div>
                            }
                        </div>
                        } @else {
                        <div class="exercise-row">
                            <div class="next-set-row">
                                <ion-icon name="checkmark-circle-outline" [color]="'primary'"></ion-icon>
                                <ion-label>
                                    {{ 'All exercises completed' | translate }}
                                </ion-label>
                            </div>
                        </div>
                        }
                    </ion-card-content>
                </ion-card>
            </swiper-slide>
            }
        </swiper-container>
    </div>
    }
    <div class="segment-toolbar-modern ion-padding">
        <ion-segment [(ngModel)]="tab" lines="none" (ngModelChange)="onTabChange($event)">
            <ion-segment-button value="programs">
                <ion-label>
                    {{'Programs' | translate}}
                </ion-label>
            </ion-segment-button>
            <ion-segment-button value="templates">
                <ion-label>
                    {{'Templates' | translate}}
                </ion-label>
            </ion-segment-button>
        </ion-segment>
        <div [ngSwitch]="tab" class="add-button-container">
            <ng-container *ngSwitchCase="'programs'">
                <button class="add-action-button" (click)="newProgram()">
                    <ion-icon name="add-circle" class="plus-icon"></ion-icon>
                    <span>{{ 'Add program' | translate }}</span>
                </button>
            </ng-container>
            <ng-container *ngSwitchCase="'templates'">
                <button class="add-action-button" (click)="newTemplate()">
                    <ion-icon name="add-circle" class="plus-icon"></ion-icon>
                    <span>{{ 'Add template' | translate }}</span>
                </button>
            </ng-container>
        </div>
    </div>

    <div [ngSwitch]="tab">
        <ng-container *ngSwitchCase="'programs'">
            <div class="programs-container ion-padding">
                @for (program of programs; track program.id) {
                <div class="program-card animate__animated animate__fadeInUp" (click)="presentProgramActionSheet(program)">
                    <div class="card-header">
                        <h2 class="program-title">{{ program.name || ('Program' | translate) }}</h2>
                        <span class="program-duration">{{ program.numberOfWeeks || 'N/A' }} {{ 'WEEKS' | translate }}</span>
                    </div>

                    @if(program.started) {
                    <div class="progress-section">
                        <div class="progress-bar">
                            <div class="progress-fill"
                                [style.width.%]="(program.completedDaysCount / program.totalDaysCount) * 100">
                            </div>
                        </div>
                        <span class="progress-label">
                            {{ program.completedDaysCount }}/{{ program.totalDaysCount }} {{ 'Completion' | translate }}
                        </span>
                    </div>
                    }

                    <p class="program-goal">{{ program.description || ('No description' | translate) }}</p>

                    @if (program.tags?.length > 0) {
                    <div class="tags-row">
                        @for (tag of program.tags; track $index) {
                        <div class="tag-pill">{{ tag | uppercase }}</div>
                        }
                    </div>
                    }

                    @if (activeProgramIds.includes(program.id)) {
                    <div class="active-indicator">
                        <ion-icon name="flash" id="active-animation"></ion-icon>
                    </div>
                    }

                    @if (!activeProgramIds.includes(program.id)) {
                    <div class="delete-action" (click)="deleteProgram(program.id); $event.stopPropagation()">
                        <ion-icon name="trash-outline"></ion-icon>
                    </div>
                    }
                </div>
                } @empty {
                <app-no-data [reloadFn]="refresh" [text]="'No programs yet.' | translate"></app-no-data>
                }
            </div>
        </ng-container>

        <ng-container *ngSwitchCase="'templates'">
            <ion-list>
                @for (template of templates; track template.exercises.length) {
                <ion-item-sliding class="animate__animated animate__fadeInUp">
                    <ion-item [button]="true" (click)="presentTemplateActionSheet(template)">
                        <ion-label>
                            <h2> {{ template.name ?? ('Template' | translate) }} ({{ template.exercises.length
                                }})
                            </h2>
                            <ion-note>
                                @for (exercise of template.exercises.slice(0, 3); track $index) {
                                {{ exercise.name }}{{ !$last ? ', ' : '' }}
                                } @empty {
                                {{ 'Blank template' | translate }}
                                }
                            </ion-note>
                        </ion-label>
                    </ion-item>
                    <ion-item-options side="start">
                        <ion-item-option color="primary" (click)="presentAssignTemplatePopover(template)">
                            <ion-icon slot="icon-only" name="person-add"></ion-icon>
                        </ion-item-option>
                    </ion-item-options>
                    <ion-item-options side="end">
                        <ion-item-option color="danger" (click)="deleteTemplate(template.id)">
                            <ion-icon slot="icon-only" name="trash"></ion-icon>
                        </ion-item-option>
                    </ion-item-options>
                </ion-item-sliding>
                } @empty {
                <app-no-data [reloadFn]="getTemplates" [text]="'No templates yet.' | translate"></app-no-data>
                }
            </ion-list>
        </ng-container>
    </div>
</ion-content>

<ng-template #setValueTemplate let-set="set">
    <div class="set-display-container">
        @if (set.weightType !== WeightType.NA) {
        <span class="weight-value">
            @if (set.weightType === WeightType.KG || set.weightType === WeightType.LB) {
            {{ set.currentWeight || set.previousWeight || set.weight }}
            }
            {{ set.weightType | weightType }}
        </span>
        <span>Ã—</span>
        }
        <span class="rep-value">
            {{ set.value }}
            @switch (set.type) {
            @case (RepType.Reps) { {{ 'reps' | translate }} }
            @case (RepType.Range) { {{ 'reps' | translate }} }
            @case (RepType.Max) { {{ 'reps' | translate }} }
            @case (RepType.Duration) { {{ 'sec' | translate }} }
            }
        </span>
    </div>
</ng-template>

<app-continue-footer></app-continue-footer>